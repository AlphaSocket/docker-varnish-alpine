#!/bin/sh
set -e

# Install all dependencies
echo "### Install all dependencies..."
apk add --no-cache gettext $SETUP_DEPENDENCIES_SETUP $SETUP_DEPENDENCIES_CONFIG $SETUP_DEPENDENCIES_RUNTIME


# Setup varnish-agent
echo "### Setup varnish-agent..."
latest_release=$( curl --silent "https://api.github.com/repos/varnish/vagent2/releases/latest" | grep '"tag_name":' | sed -E 's/.*"([^"]+)".*/\1/' )
cd /tmp
wget https://github.com/varnish/vagent2/archive/$latest_release.tar.gz
tar zxvf "$latest_release.tar.gz"
cd "vagent2-$latest_release/" && ./autogen.sh && ./configure && make && make install
cd /
rm -rf /tmp/$latest_release


# Remove unecessary dependencies
echo "### Remove unecessary dependencies..."
echo "$SETUP_DEPENDENCIES_SETUP" | tr ' ' "\n" > /tmp/A
echo "$SETUP_DEPENDENCIES_CONFIG $SETUP_DEPENDENCIES_RUNTIME" | tr ' ' "\n"  > /tmp/B
UNNECESSARY_DEPENDENDCY_SETUP=$( grep -Fxv -f /tmp/B /tmp/A | xargs )
rm -f /tmp/A /tmp/B
apk del --no-cache $UNNECESSARY_DEPENDENDCY_SETUP



exit 0